use core::panic;
use std::{collections::HashSet, str::Chars};

const _INPUT: &str = "....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...";

#[derive(Clone, Copy, Debug, PartialEq, Eq, Hash)]
struct Vec2 {
    x: i32,
    y: i32,
}

impl Vec2 {
    fn add(self, dir: Direction) -> Self {
        let dir = dir.as_vec2();
        Vec2 {
            x: self.x + dir.x,
            y: self.y + dir.y,
        }
    }
}

#[derive(Clone, Copy, PartialEq, Eq, Hash)]
enum Direction {
    Up = 0,
    Right = 1,
    Down = 2,
    Left = 3,
}

impl Direction {
    fn next(self) -> Self {
        match self {
            Self::Up => Self::Right,
            Self::Right => Self::Down,
            Self::Down => Self::Left,
            Self::Left => Self::Up,
        }
    }

    fn as_vec2(self) -> Vec2 {
        let (x, y) = match self {
            Direction::Up => (0, -1),
            Direction::Right => (1, 0),
            Direction::Down => (0, 1),
            Direction::Left => (-1, 0),
        };
        Vec2 { x, y }
    }
}

struct Grid {
    grid: Vec<Vec<char>>,
    direction: Direction,
    visited_corners: HashSet<(Direction, Vec2)>,
}

impl Grid {
    fn get(&self, pos: Vec2) -> char {
        self.grid[pos.y as usize][pos.x as usize]
    }

    fn update(&mut self, pos: Vec2, c: char) {
        self.grid[pos.y as usize][pos.x as usize] = c;
    }

    fn find(&self, c: char) -> Vec2 {
        for (y, row) in self.grid.iter().enumerate() {
            for (x, content) in row.iter().enumerate() {
                if &c == content {
                    return Vec2 {
                        x: x as i32,
                        y: y as i32,
                    };
                }
            }
        }
        panic!()
    }

    fn count(&self, c: char) -> i32 {
        let mut count = 0;
        for row in self.grid.iter() {
            for content in row.iter() {
                if &c == content {
                    count += 1;
                }
            }
        }
        count
    }

    fn out_of_bounds(&self, pos: Vec2) -> bool {
        let size = self.size();
        pos.x < 0 || pos.y < 0 || pos.x >= size.x || pos.y >= size.y
    }

    fn traverse_grid(&mut self, current_pos: Vec2) -> bool {
        if self
            .visited_corners
            .contains(&(self.direction, current_pos))
        {
            return true;
        }
        self.visited_corners.insert((self.direction, current_pos));
        self.update(current_pos, 'X');
        let mut next_pos = current_pos.add(self.direction);
        if self.out_of_bounds(next_pos) {
            return false;
        }
        let next_chr = self.get(next_pos);
        if next_chr == '#' {
            self.direction = self.direction.next();
            next_pos = current_pos.add(self.direction);
            if self.visited_corners.contains(&(self.direction, next_pos)) {
                return true;
            }
        }
        self.traverse_grid(next_pos)
    }

    fn size(&self) -> Vec2 {
        Vec2 {
            x: self.grid[0].len() as i32,
            y: self.grid.len() as i32,
        }
    }

    fn possible_loops(&mut self) -> i32 {
        let start = self.find('^');

        let mut count = 0;
        let size = self.size();
        self.traverse_grid(start);
        self.update(start, '^');

        for x in 0..size.x {
            for y in 0..size.y {
                let pos = Vec2 { x, y };
                if !['#', '^'].contains(&self.get(pos)) {
                    let mut clone = grid();
                    clone.update(pos, '#');
                    if clone.traverse_grid(start) {
                        clone.update(pos, 'O');
                        count += 1;
                    }
                }
            }
        }
        count
    }

    fn print_grid(&self) {
        println!("PRINTING GRID");
        println!();
        for row in self.grid.iter().rev() {
            for c in row {
                print!("{c}");
            }
            println!();
        }
    }
}

fn grid() -> Grid {
    Grid {
        grid: INPUT
            .lines()
            //.rev()
            .map(str::chars)
            .map(Chars::collect)
            .collect::<Vec<_>>(),
        direction: Direction::Up,
        visited_corners: HashSet::new(),
    }
}

pub fn solve_part1() -> i32 {
    let mut grid = grid();
    let start = grid.find('^');

    grid.traverse_grid(start);
    println!("size {:?}", grid.size());
    grid.count('X')
}

pub fn solve_part2() -> i32 {
    let mut grid = grid();
    grid.possible_loops()
}

const INPUT: &str = r#"........#.............................................#.........#..............#.......#....................#....................#
......................#........#........................#.............##............................#.#.............#..........#..
....#..................................#..................#.........#....#..............#..#......................#........#...#..
.....#...#...............#................#..........................#......#.....................#.......................#.......
......................................................##.#....#..................................................................#
#....#....................#..................................#.....................................#......................#.......
.......#...........................#.......................#......#...#.................................................#...#.....
....................##..........................#................#..........................#.#..................#....#.........#.
#..................................#...............#...............#.........................#............##......................
.............................#....................................#...............#.........#..........#.......................#..
.................................#............###.......#............##......#...............................#...............#.#..
.#..........................................#.......#.......................##..#........#........#...............#...............
......#...#............#.#..............#...................#..........................................................##.........
#................##....................................................................#........#.................#...#...........
...#..........#..........................##......#....#..............................#......................................#.....
..............................##.#..........................................................#..............................#......
......#...........#....#..................#............#....................................................................#.....
.....................#........................#.......................................................#...........................
...................#.#..........................................................................................#.#...............
.........................................##.........................................................#.......#...###......#........
...............................................................##.......................#..........................#..............
...#...........#.................#..............#......#.....#..........................#....................#....#...............
.................................#................#................#..............................................#.......##.....#
........#..........................#................#.......................#...................#.................................
.............................#.............................#..........#.........................#........#........................
....#................#.#................#...........................................................#...#....#......#......#......
........#..............................#...............................#.................#........................................
...........................................#..#........#...#...........#..#.............#.........................................
.#.................#.#................................#................#.#..................................#........#............
.......#..........................................#.................................................................#.............
...................#....................................................#..#...............................................#......
...#.#........#...#.....#.....................................................................................................#...
......#.........................#......................#.............#.....................#......................................
..........................#............#.................................#..#..........#........#......................#..........
...#..#......#.......................#........................#...................................................................
............#...........#................#..............#.........................................................................
.#........#....#.........................................#........................................#...............................
...#......................##.........#.......#.#...........#................................................#...#.................
...........#......#.........#....#.....#.......................................................#.............#....................
.............#...#..............................................#.........#.....##....................#...#.........#.............
...............#................................#..........................................#.....#.#.........................#...#
................#.....#..#.............#..............#..............#.......#....................................................
......#.........................................................................................................#.........##......
..#...........................#.#...........................................#..#.....#............................................
...#...#..................#..................................#.........#...................#..................................#...
............#..#.....................#.........................................#.......#..................................#.......
...#.......................................................................#.............................#........................
......#..................#....................................#......##...........................................................
.#...............#.....#..........................................................................................#...............
...#.............#.........................#.....................#...#..........#....#............................#...............
...#............................#.......#...........#.........#........#.....#...........#...................................#....
.....................#...................#................................#...............................#......#.........#..##..
.............#........................................................................................#........................##.
.....#.......#.......#............................................................................................................
............................................#................................................................#..............#.....
....#..#......................................................#...................................................#...............
.................................#...##..................#.................................................#....#.................
........#...................................#...#..........................................................#......................
........................#........##...........#.......#........#...................................#..............................
...........#...#...................................................#..............#......#...............#.#..................#...
........#.............................................#...........................................................................
........#................#......#..........#..#........#.#.......#...#........................#..#......................#.......#.
.......#..........................................................................................................#.....#.....#...
......................##....................#.....#.................#...........#.......................#.##..........#......#....
....................................##....................................................................#.................#.....
..#.................................#.#...........#............................................#....#.............................
#...................................#...........................................#............#.........#...............#..........
.......................#.............................................................#..........#...#.............#.....#.........
#..................#.#.............................................................................#.................#............
.....................#......#.......#...........#..........................................^...............................#......
................................#......................#.#.....#..............#..................#....#.#......#....#.............
............................................................................#........#.....................................#......
.............#......................................................#...................................#......##..#....#.........
...............#.................#...................#...............#............................................................
..............#...........#..#...........................................#...................................#..........#.........
..........#...........................#...................#..............#...#.......#..........#...................#.............
.............#.#..................................#....#..#............#.....................#................#...#.....#.........
...................#..........................................................#............##.....................................
...........................................#............#........................................................................#
..#..............................#....#...........................................................................................
..#..#............#...........................#...#...........#............#.....#.................#..............................
....#...................#.........#...............................................................................................
.......#..........................#....................................##........#.................##...#.#........#..#...........
.#........................#....#.......#.....#...................#.............................................#..................
..#...............................................................#................................................#..............
.....#........................................#...................................................................................
..........................................#..........................................................#............................
....................###.........................#............................#...#...........#............#.......................
.....#.....#...............#........#.#....#...................#...........#........#...........#.................................
................................................................................................#...##............................
......................#............#.........................#.......................#.....#...........#...#.#....................
............................#....................#..................#..............#..................................#...........
...........................#...................................#..............................................................#...
..................#................#.....................#...................#........#..............#............................
............#.............#.....................#..................#.........#......................#............#............#...
....#..........................#...............................................................................................#..
................#.....................................#.............................#...........#........................#........
#.##...........#.........................................#...............#..........................................#.#...........
........................................#..............#.....................#............#.....#.................................
.......#....##..#..#.....#........................................................................................................
....##.............#..............................#...............................................................................
.....#........................#.........#..#......#........#......................#.......#..............#..........#.......#.....
..#....#.........................#.#....................#..#.......#.............#..................#........#..................#.
..........##....#........................................................................#........................................
........#......#................................................................................................#................#
.....#.......#...#.............#....................................#..#........................#...#..............#....#.........
.............#...................................................##...#...........................................................
..............#.............................................#.............#................#.............#..............#.........
..#....#..........#.....#......#......................#................................#...............................#..........
.................................................................................##......#...........................#.....#......
..#....#..........#.......#.........................................#...............#..#............................#........#....
...........#........#.#....................#........#.....................................#..................#....................
.......#............#................#...........#.............#......#.........#...........................#.....................
#.#....#.#...............#....#.....#.......................#...............................#...................##...#............
.................##...#.................................................................#...........................#.............
.....#........................................#.........#...................................................#.....................
....................#.....................#................................................#...##.....................#...........
...............#...............................................................#....#.............................................
.................#................#...#.....................................#......#....................#...............#.#.......
...................#............................................#..#....#..#........#...............................#.........#...
..#........#...............#..................#.....#..................#.....................................#........##...#......
.....#.....#....#.....#................#.#.....................##.............................................................#...
................#............#......#......#.......................................................#....................#........#
........#..............#..#......................................................................##.....##........................
.........#.............................#.........#.......................................#..........................#.##..........
.#...................#........................................................#....#......................................#.......
....#..........#.....#.........................................................................................#..................
.......#.............................#............#.........................#....#....#........#......#.....#.......#.............
..#.......#........................#........................#.....................................................................
........................#...............................#.#.............#................................#..................#....."#;

const INPUT_: &str = "..#.........#...#......#...........#.#...#............#...#.........#....#......................#......#..........................
...........#....#.............#.....................................#............................................#.....#..........
.................#.........#.......#.......#..#............#.........#.........#............................................#.....
......#................................#.........................................#................................................
#...............................##......#.#...........................#....................#...#...............#.................#
.............#......#...........................................#..............#..........#..............#........................
...#...................#..............#........#.......#..........#.........................#.#.....#.....#.......................
#.#...#.............................#.................................................#..............#............#...............
.............................#.......#.............#......#...............#.....#.................................................
....................................#.....................................#.................#........#..........#.#..#...........#
......................#......#...............................#.................#.......#......................#.......#...........
...#..............#....................#............#...........##..#.....................................................#.......
....#.........#...................................#................................................#..........................#...
..............#.....#.................................................................#..#.....##.......#.........................
.........#....#...........##..........................................#......#.....................#..........#.......#...........
..#....#..........#.................................................................#....#............#............#........#.....
............#.#....#...........#.............#...........#..................#.....#.................................#.......#.....
..........#.......#............................#........#...........#.......#...#....#........#.............##.#............#.....
...................#.........#....#.....................................................................#.#..........#............
.#...#.#..................#...............................................#...........................#......................#....
.........#..............#.........#.......#.#......##..................#......#...#..#...........#.....................#..........
...............................#.............#..#......#............#..........#......................#..........#.............#..
..........#.....#..........................#..................................................#.#..#.....#........................
............#..##.................................#....................#.....#.......................................#............
......................#.#...................#......#..............................................................#...............
.......#.............................................................................#............................................
........#.................#....................................................#.......................................#....##.#..
..................#........................#......#..##....#.........#...##..#....................................#...............
.............#..............................................................................##...#......#.................#.......
..................................#.#.............................................................................#...............
...........#.................................#.......................................................................#......#.....
.....#............................................................#................................................#..............
.....#...........#.#..........#..............#..........................#.................................................#.......
....#........#...#..........#..#..........................................................................#.......................
.........................................................................#.....#.......................................#....#.....
...............#...#..#.....#.......................#.................#........#..........##....................................#.
.......................#....#...#..................#..................#.....................................#.............#.......
...........#..#...#..............................................^........#........................#......................#.......
.............................................#.................................................................................#..
......#...#.........#.....................................#...............................................#..#....#.......#.......
...#......................................................#.................#..#.............................................#....
.....#......................#.......................................#.............................................#....#..........
...#.....................................................#......#...#.......#....#..............................#....#............
......#.....#.....#...........#...#................#...........................................#..................................
...................................#...............#......................................................#.......................
..............................#...#........................................................#.#.............#......................
......#.......#............#..#......................#..#.....#..................#......#.........................................
#......#....#.......#....................#.....#.#............................................................................#...
.#....#...................................#.................#....................#........................................#.......
............................................#...................................#.......#..............#.........................#
............##.........#..............................................................................#.........#.................
##.................................................#.......................#.#.....#..............................................
...........................#..........#...#.#.........................#.................................##.....#..................
.............#..........#........................................#............#............#.....................................#
.....................................................#.................................................#..........................
.....#........................................#.............................#...#.....................#...........................
.......#..................................#...........#.......#.....#........................................#.......#............
.............#.......................#......................#.....#.......#..................................#..#........#........
.......................................................#......#...............#.........#.............#............#..............
....#...............................#.#.....................#.................................................................#..#
...........................#........#..........................................#........................................#.........
....#.............................................................................................................................
.##........#.......#..................#.#....#.............................................................#.##...................
.#..#.......................##........................................................#...............................#...........
.....#.#..............#...........................................#...............................................................
.....#.#............................#.............................................................................................
......................#............................#....#............................................................#............
.......#.......................................................................#..................#...##..........................
...............#...................................................#.....................................#...............#.#......
....#..........#.......#..#................................#......................................................................
#......##..................................................................#...#........................#.........................
..................................#........................................................................#...........#......#...
.#....................#....#..................................#..#..................#.#.......................#...................
......#..#................................................................................................##......................
.....##........#..#.......................#.........#............#....#...........................................................
...............#...........#.................#...........#.........#.......................#.........#........................#...
............................................................................................#..#..................................
..........................................#.............#..#...............#.............................#.#......#.............#.
......................#............#..........#............................................................#...#................#.
...........#...................#..................................................................................................
.......#........................#.................................................................#.................#.............
#...##................#......................................................................#................................#...
...#.....#.......................#...#..............#....................#.........#.........#....................................
....#.....................................#.............................................................................#.........
.........#..............................................................................#..............#..........................
...................................#.#...............#........................................................................##..
.........#............#..............#..........................................................................#...#.............
.....#.......................#..#....#.#....................#..........................................#..........................
.......................................#........#.........#.....................#.............#...........#...............#.......
................#.................................................................................................................
.......#....................................#..................#...........#.....#.........................#......................
...................#................................................................#...............#................#............
..........#.......................#......................#...........#..#........#....#.........................#.................
...................#........................#.......#................................................#............................
.......................#......................................................#...........#.......#...................#...........
........#..........#........#......#......................#......................................#...............#................
...........................................................#...#..................................................................
.......................#......................#............#..#....#...#............................#.............................
.#.#...............#..........#..........##........#..............................................................................
##.........#....................#...................#.........#......................##..................#...............#........
.#......................#...#...#......................#............#......................#.................#..................#.
#..............................#......................................#.........#.#...............................................
...........#....#......#.......#..........................#..........................................#......#............#..#.....
................................................................................................#.......#.........................
....#..................................#..........................#.................................#...#...#.....................
.......................#.#..#.............................#.#...........................#......#..........#.......................
...##.......................................#..................#....................#.............................................
...#.......#........................#..........##.....#............#......................#.....................................#.
......#..............#.............................#.............................................#.............................#..
#...........................................#.......#....#.#..........#........#............#.......................#.......#.....
..................#.......#............#.....#.............................................................#......................
.#.....................................................................................#...................................#......
...........#.........#.#.................#..........................#............................................#.......##.......
.......................#......#.................................................#........................#.................#......
..................#........................................................#................................................#....#
...............................#.......#....#.........#..........#.....#.......................................#..#...............
......##................##...#....#...#...#............................................................................#..........
.......................#............#...................................#....#.......#.............................#..............
..............................#.........................................................#........#.............#..................
........................#............................................#..................#.....#...................#...............
............#......#...............................#.............................................................................#
.#.........#.........#.........#.......#.#..#...#...............................#.......#.........#..........................#....
........................#.................................................#....................................##......#..........
....#.......#.....................##...#..........................................................................................
.................................#.......................................#.......................#.#......#.......................
.#.............#..................#...........................#.................#...........................................#.....
.....#.........#................#..........#..#..........#......................#...#......................#....#.................
.................#......#.....................................................................#...................................
......................#.......................................................#..#......#..............#..#..#..........#.........
...............................#.........#........#..................#.#.........#.#.#........#..#.........#....##...#............";
